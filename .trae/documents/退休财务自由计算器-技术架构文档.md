# é€€ä¼‘è´¢åŠ¡è‡ªç”±è®¡ç®—å™¨ - æŠ€æœ¯æ¶æ„æ–‡æ¡£

## 1. æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[ç”¨æˆ·æµè§ˆå™¨] --> B[Reactå‰ç«¯åº”ç”¨]
    B --> C[æ¨¡å¼åˆ‡æ¢å™¨]
    B --> D[åŠ¨æ€è¡¨å•ç»„ä»¶]
    B --> E[åŒæ¨¡å¼è®¡ç®—å¼•æ“]
    B --> F[è¾“å…¥éªŒè¯æ¨¡å—]
    B --> G[ç»“æœå±•ç¤ºç»„ä»¶]
    
    subgraph "å‰ç«¯å±‚"
        B
        C
        D
        E
        F
        G
    end
    
    subgraph "è®¡ç®—å±‚"
        H[æ­£å‘è®¡ç®—é€»è¾‘]
        I[åå‘è®¡ç®—é€»è¾‘]
        J[äºŒåˆ†æŸ¥æ‰¾ç®—æ³•]
    end
    
    subgraph "æ•°æ®å±‚ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰"
        K[LocalStorage]
        L[På€¼æŸ¥è¯¢è¡¨]
    end
    
    E --> H
    E --> I
    I --> J
    E --> L
    B --> K
```

## 2. æŠ€æœ¯æè¿°

- å‰ç«¯ï¼šReact@18 + TypeScript + Tailwind CSS@3 + Vite
- çŠ¶æ€ç®¡ç†ï¼šReact Hooks (useState, useEffect)
- æ„å»ºå·¥å…·ï¼šVite
- éƒ¨ç½²ï¼šé™æ€ç½‘ç«™æ‰˜ç®¡

## 3. è·¯ç”±å®šä¹‰

| è·¯ç”± | ç”¨é€” |
|------|------|
| / | è®¡ç®—å™¨ä¸»é¡µé¢ï¼ŒåŒ…å«æ‰€æœ‰è¾“å…¥å‚æ•°ã€è®¡ç®—é€»è¾‘å’Œç»“æœå±•ç¤º |

## 4. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 4.1 åŒæ¨¡å¼è®¡ç®—å¼•æ“

```typescript
// è®¡ç®—æ¨¡å¼æšä¸¾
enum CalculationMode {
  CALCULATE_INVESTMENT = 'calculate_investment',
  CALCULATE_RETIREMENT_AGE = 'calculate_retirement_age'
}

// æ‰©å±•çš„è®¡ç®—å‚æ•°æ¥å£
interface CalculationParams {
  currentAge: number;
  retirementAge?: number; // ç®—æŠ•èµ„é‡‘é¢æ¨¡å¼å¿…å¡«
  monthlyInvestment?: number; // ç®—é€€ä¼‘å¹´é¾„æ¨¡å¼å¿…å¡«
  currentAnnualExpense: number;
  currentPassiveIncome: number;
  expectedRetirementPassiveIncome: number;
  currentInvestmentAssets: number;
  inflationRate: number;
  investmentReturn: number;
  retirementExpenseRatio: number;
  withdrawalRate: number;
}

// æ‰©å±•çš„è®¡ç®—ç»“æœæ¥å£
interface CalculationResult {
  mode: CalculationMode;
  yearsToRetirement: number;
  calculatedRetirementAge?: number; // ç®—é€€ä¼‘å¹´é¾„æ¨¡å¼ç»“æœ
  inflationFactor: number;
  retirementAnnualExpense: number;
  retirementPassiveIncome: number;
  investmentNeededToCoverExpense: number;
  totalAssetsNeeded: number;
  currentAssetsFutureValue: number;
  fundingGap: number;
  pValue: number;
  annualInvestmentNeeded: number;
}
```

### 4.2 På€¼æŸ¥è¯¢è¡¨

```typescript
const P_VALUE_TABLE: Record<number, number> = {
  5: 7.7,    // 60å²é€€ä¼‘
  10: 18.5,  // 55å²é€€ä¼‘
  15: 36,    // 50å²é€€ä¼‘
  20: 64,    // 45å²é€€ä¼‘
  25: 109,   // 40å²é€€ä¼‘
  30: 182,   // 35å²é€€ä¼‘
  35: 299,   // 30å²é€€ä¼‘
  40: 488    // 25å²é€€ä¼‘
};

// På€¼æŸ¥è¯¢å‡½æ•°
function getPValue(yearsToRetirement: number): number {
  const availableYears = Object.keys(P_VALUE_TABLE)
    .map(Number)
    .sort((a, b) => a - b);
  
  // æ‰¾åˆ°æœ€æ¥è¿‘ä¸”ä¸å¤§äºç›®æ ‡å¹´æ•°çš„å€¼
  for (let i = availableYears.length - 1; i >= 0; i--) {
    if (yearsToRetirement >= availableYears[i]) {
      return P_VALUE_TABLE[availableYears[i]];
    }
  }
  
  // å¦‚æœå°äºæœ€å°å€¼ï¼Œè¿”å›æœ€å°å€¼å¯¹åº”çš„På€¼
  return P_VALUE_TABLE[availableYears[0]];
}
```

### 4.3 åŒæ¨¡å¼è®¡ç®—é€»è¾‘å®ç°

#### 4.3.1 æ­£å‘è®¡ç®—ï¼ˆç®—æŠ•èµ„é‡‘é¢æ¨¡å¼ï¼‰

```typescript
function calculateInvestmentAmount(params: CalculationParams): CalculationResult {
  // 1. é€€ä¼‘å¹´æ•°(N)
  const yearsToRetirement = params.retirementAge! - params.currentAge;
  
  // 2. é€šèƒ€å› å­(INF)
  const inflationFactor = Math.pow(1 + params.inflationRate / 100, yearsToRetirement);
  
  // 3. é€€ä¼‘æ—¶å¹´å¼€æ”¯
  const retirementAnnualExpense = params.currentAnnualExpense * inflationFactor * (params.retirementExpenseRatio / 100);
  
  // 4. é€€ä¼‘æ—¶è¢«åŠ¨æ”¶å…¥
  const retirementPassiveIncome = (params.currentPassiveIncome * inflationFactor) + params.expectedRetirementPassiveIncome;
  
  // 5. éœ€æŠ•èµ„è¦†ç›–å¼€æ”¯
  const investmentNeededToCoverExpense = retirementAnnualExpense - retirementPassiveIncome;
  
  // 6. é€€ä¼‘æ‰€éœ€æ€»èµ„äº§(F)
  const totalAssetsNeeded = investmentNeededToCoverExpense / (params.withdrawalRate / 100);
  
  // 7. å½“å‰èµ„äº§æœªæ¥ä»·å€¼
  const currentAssetsFutureValue = params.currentInvestmentAssets * Math.pow(1 + params.investmentReturn / 100, yearsToRetirement);
  
  // 8. èµ„é‡‘ç¼ºå£(D)
  const fundingGap = totalAssetsNeeded - currentAssetsFutureValue;
  
  // 9. è·å–På€¼
  const pValue = getPValue(yearsToRetirement);
  
  // 10. å¹´åº¦æŠ•èµ„é¢(Y)
  const annualInvestmentNeeded = fundingGap / pValue;
  
  return {
    mode: CalculationMode.CALCULATE_INVESTMENT,
    yearsToRetirement,
    inflationFactor,
    retirementAnnualExpense,
    retirementPassiveIncome,
    investmentNeededToCoverExpense,
    totalAssetsNeeded,
    currentAssetsFutureValue,
    fundingGap,
    pValue,
    annualInvestmentNeeded
  };
}
```

#### 4.3.2 åå‘è®¡ç®—ï¼ˆç®—é€€ä¼‘å¹´é¾„æ¨¡å¼ï¼‰

```typescript
function calculateRetirementAge(params: CalculationParams): CalculationResult {
  const targetAnnualInvestment = params.monthlyInvestment! * 12;
  
  // ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ³•æ±‚è§£é€€ä¼‘å¹´æ•°
  let minYears = 1;
  let maxYears = 50;
  let bestYears = minYears;
  const tolerance = 0.01; // å®¹å·®
  
  while (maxYears - minYears > tolerance) {
    const midYears = (minYears + maxYears) / 2;
    const testRetirementAge = params.currentAge + midYears;
    
    // ä½¿ç”¨å½“å‰å¹´æ•°è®¡ç®—æ‰€éœ€æŠ•èµ„é¢
    const testParams = {
      ...params,
      retirementAge: testRetirementAge
    };
    
    const result = calculateInvestmentAmount(testParams);
    
    if (result.annualInvestmentNeeded <= targetAnnualInvestment) {
      // æ‰€éœ€æŠ•èµ„é¢å°äºç­‰äºç›®æ ‡ï¼Œå¯ä»¥æ›´æ—©é€€ä¼‘
      maxYears = midYears;
      bestYears = midYears;
    } else {
      // æ‰€éœ€æŠ•èµ„é¢å¤§äºç›®æ ‡ï¼Œéœ€è¦å»¶åé€€ä¼‘
      minYears = midYears;
    }
  }
  
  const calculatedRetirementAge = params.currentAge + bestYears;
  
  // ä½¿ç”¨æœ€ç»ˆç»“æœé‡æ–°è®¡ç®—å®Œæ•´æ•°æ®
  const finalParams = {
    ...params,
    retirementAge: calculatedRetirementAge
  };
  
  const finalResult = calculateInvestmentAmount(finalParams);
  
  return {
    ...finalResult,
    mode: CalculationMode.CALCULATE_RETIREMENT_AGE,
    calculatedRetirementAge: Math.round(calculatedRetirementAge)
  };
}
```

#### 4.3.3 ç»Ÿä¸€è®¡ç®—å…¥å£

```typescript
function calculate(params: CalculationParams, mode: CalculationMode): CalculationResult {
  switch (mode) {
    case CalculationMode.CALCULATE_INVESTMENT:
      return calculateInvestmentAmount(params);
    case CalculationMode.CALCULATE_RETIREMENT_AGE:
      return calculateRetirementAge(params);
    default:
      throw new Error('æœªçŸ¥çš„è®¡ç®—æ¨¡å¼');
  }
}
```

## 5. UIç»„ä»¶è®¾è®¡

### 5.1 æ¨¡å¼åˆ‡æ¢å™¨ç»„ä»¶

```typescript
interface ModeToggleProps {
  mode: CalculationMode;
  onChange: (mode: CalculationMode) => void;
}

const ModeToggle: React.FC<ModeToggleProps> = ({ mode, onChange }) => {
  const options = [
    {
      label: 'ç®—æŠ•èµ„é‡‘é¢',
      value: CalculationMode.CALCULATE_INVESTMENT,
      icon: 'ğŸ’°'
    },
    {
      label: 'ç®—é€€ä¼‘å¹´é¾„',
      value: CalculationMode.CALCULATE_RETIREMENT_AGE,
      icon: 'ğŸ“…'
    }
  ];
  
  return (
    <Segmented
      options={options}
      value={mode}
      onChange={onChange}
      size="large"
      className="mb-6"
    />
  );
};
```

### 5.2 åŠ¨æ€è¡¨å•ç»„ä»¶

```typescript
interface DynamicFormProps {
  mode: CalculationMode;
  params: CalculationParams;
  onChange: (params: CalculationParams) => void;
  errors: Record<string, string>;
}

const DynamicForm: React.FC<DynamicFormProps> = ({ mode, params, onChange, errors }) => {
  const getVisibleFields = () => {
    const commonFields = [
      'currentAge',
      'currentAnnualExpense',
      'currentPassiveIncome',
      'expectedRetirementPassiveIncome',
      'currentInvestmentAssets',
      'inflationRate',
      'investmentReturn',
      'retirementExpenseRatio',
      'withdrawalRate'
    ];
    
    if (mode === CalculationMode.CALCULATE_INVESTMENT) {
      return [...commonFields, 'retirementAge'];
    } else {
      return [...commonFields, 'monthlyInvestment'];
    }
  };
  
  return (
    <Form layout="vertical">
      {getVisibleFields().map(field => (
        <FormField
          key={field}
          field={field}
          value={params[field]}
          onChange={(value) => onChange({ ...params, [field]: value })}
          error={errors[field]}
        />
      ))}
    </Form>
  );
};
```

### 5.3 ç»“æœå±•ç¤ºç»„ä»¶

```typescript
interface ResultDisplayProps {
  result: CalculationResult | null;
  mode: CalculationMode;
}

const ResultDisplay: React.FC<ResultDisplayProps> = ({ result, mode }) => {
  if (!result) return null;
  
  const getMainResult = () => {
    if (mode === CalculationMode.CALCULATE_INVESTMENT) {
      return {
        title: 'æ¯å¹´éœ€æŠ•èµ„é‡‘é¢',
        value: result.annualInvestmentNeeded,
        unit: 'ä¸‡å…ƒ',
        description: 'ä¸ºå®ç°è´¢åŠ¡è‡ªç”±ç›®æ ‡ï¼Œæ‚¨æ¯å¹´éœ€è¦æŠ•èµ„çš„é‡‘é¢'
      };
    } else {
      return {
        title: 'å¯é€€ä¼‘å¹´é¾„',
        value: result.calculatedRetirementAge!,
        unit: 'å²',
        description: `æŒ‰å½“å‰æŠ•èµ„è®¡åˆ’ï¼Œæ‚¨å¯ä»¥åœ¨${result.yearsToRetirement.toFixed(1)}å¹´åé€€ä¼‘`
      };
    }
  };
  
  const mainResult = getMainResult();
  
  return (
    <Card className="result-card">
      <div className="main-result">
        <h3>{mainResult.title}</h3>
        <div className="result-value">
          {mainResult.value.toFixed(1)} {mainResult.unit}
        </div>
        <p>{mainResult.description}</p>
      </div>
      
      <Divider />
      
      <div className="detailed-results">
        {/* è¯¦ç»†è®¡ç®—ç»“æœå±•ç¤º */}
      </div>
    </Card>
  );
};
```

## 6. è¾“å…¥éªŒè¯è§„åˆ™

```typescript
interface ValidationRule {
  field: keyof CalculationParams;
  validate: (value: number, params: CalculationParams, mode: CalculationMode) => string | null;
}

const VALIDATION_RULES: ValidationRule[] = [
  {
    field: 'currentAge',
    validate: (value) => {
      if (value < 18 || value > 100) return 'å½“å‰å¹´é¾„å¿…é¡»åœ¨18-100å²ä¹‹é—´';
      return null;
    }
  },
  {
    field: 'retirementAge',
    validate: (value, params, mode) => {
      if (mode !== CalculationMode.CALCULATE_INVESTMENT) return null;
      if (value <= params.currentAge) return 'é€€ä¼‘å¹´é¾„å¿…é¡»å¤§äºå½“å‰å¹´é¾„';
      if (value > 100) return 'é€€ä¼‘å¹´é¾„ä¸èƒ½è¶…è¿‡100å²';
      return null;
    }
  },
  {
    field: 'monthlyInvestment',
    validate: (value, params, mode) => {
      if (mode !== CalculationMode.CALCULATE_RETIREMENT_AGE) return null;
      if (value <= 0) return 'æ¯æœˆæŠ•èµ„é‡‘é¢å¿…é¡»å¤§äº0';
      return null;
    }
  },
  {
    field: 'currentAnnualExpense',
    validate: (value) => {
      if (value < 0) return 'å¹´ç”Ÿæ´»å¼€æ”¯ä¸èƒ½ä¸ºè´Ÿæ•°';
      return null;
    }
  },
  {
    field: 'inflationRate',
    validate: (value) => {
      if (value < 0 || value > 20) return 'é€šèƒ€ç‡åº”åœ¨0-20%ä¹‹é—´';
      return null;
    }
  },
  {
    field: 'investmentReturn',
    validate: (value) => {
      if (value < 0 || value > 30) return 'æŠ•èµ„æ”¶ç›Šç‡åº”åœ¨0-30%ä¹‹é—´';
      return null;
    }
  }
];
```

## 7. çŠ¶æ€ç®¡ç†è®¾è®¡

```typescript
// ä¸»è¦çŠ¶æ€æ¥å£
interface CalculatorState {
  mode: CalculationMode;
  params: CalculationParams;
  result: CalculationResult | null;
  errors: Record<string, string>;
  isCalculating: boolean;
}

// çŠ¶æ€ç®¡ç†Hook
const useCalculator = () => {
  const [state, setState] = useState<CalculatorState>({
    mode: CalculationMode.CALCULATE_INVESTMENT,
    params: getDefaultParams(),
    result: null,
    errors: {},
    isCalculating: false
  });
  
  const setMode = (mode: CalculationMode) => {
    setState(prev => ({
      ...prev,
      mode,
      result: null,
      errors: {}
    }));
  };
  
  const updateParams = (params: CalculationParams) => {
    setState(prev => ({ ...prev, params }));
  };
  
  const performCalculation = useCallback(() => {
    setState(prev => ({ ...prev, isCalculating: true }));
    
    try {
      const errors = validateParams(state.params, state.mode);
      if (Object.keys(errors).length > 0) {
        setState(prev => ({ ...prev, errors, isCalculating: false }));
        return;
      }
      
      const result = calculate(state.params, state.mode);
      setState(prev => ({
        ...prev,
        result,
        errors: {},
        isCalculating: false
      }));
    } catch (error) {
      setState(prev => ({
        ...prev,
        errors: { general: 'è®¡ç®—è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯' },
        isCalculating: false
      }));
    }
  }, [state.params, state.mode]);
  
  return {
    ...state,
    setMode,
    updateParams,
    performCalculation
  };
};
```

## 8. å®ç°ä¼˜å…ˆçº§

### 8.1 ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½
1. æ‰©å±•æ•°æ®ç»“æ„ï¼ˆCalculationModeã€CalculationParamsã€CalculationResultï¼‰
2. å®ç°åå‘è®¡ç®—é€»è¾‘ï¼ˆäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼‰
3. æ›´æ–°è¾“å…¥éªŒè¯è§„åˆ™
4. ä¿®æ”¹ç°æœ‰è®¡ç®—å‡½æ•°ä»¥æ”¯æŒåŒæ¨¡å¼

### 8.2 ç¬¬äºŒé˜¶æ®µï¼šUIç»„ä»¶
1. å®ç°æ¨¡å¼åˆ‡æ¢å™¨ç»„ä»¶
2. ä¿®æ”¹åŠ¨æ€è¡¨å•ç»„ä»¶ä»¥æ”¯æŒä¸åŒæ¨¡å¼çš„å­—æ®µæ˜¾ç¤º
3. æ›´æ–°ç»“æœå±•ç¤ºç»„ä»¶ä»¥é€‚åº”ä¸åŒæ¨¡å¼çš„ç»“æœ
4. é›†æˆçŠ¶æ€ç®¡ç†Hook

### 8.3 ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å’Œæµ‹è¯•
1. æ€§èƒ½ä¼˜åŒ–ï¼ˆè®¡ç®—ç¼“å­˜ã€é˜²æŠ–å¤„ç†ï¼‰
2. è¾¹ç•Œæƒ…å†µå¤„ç†
3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆåŠ è½½çŠ¶æ€ã€åŠ¨ç”»æ•ˆæœï¼‰
4. å…¨é¢æµ‹è¯•å’Œè°ƒè¯•

### 8.4 æŠ€æœ¯é£é™©è¯„ä¼°
- **åå‘è®¡ç®—å¤æ‚åº¦**ï¼šäºŒåˆ†æŸ¥æ‰¾ç®—æ³•å¯èƒ½åœ¨æç«¯å‚æ•°ä¸‹æ”¶æ•›è¾ƒæ…¢
- **æ•°å€¼ç²¾åº¦**ï¼šæµ®ç‚¹æ•°è®¡ç®—å¯èƒ½å­˜åœ¨ç²¾åº¦é—®é¢˜
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ¨¡å¼åˆ‡æ¢æ—¶çš„æ•°æ®ä¿æŒå’Œé‡ç½®ç­–ç•¥éœ€è¦ä»”ç»†è®¾è®¡

### 8.5 æ€§èƒ½è€ƒè™‘
- ä½¿ç”¨ `useMemo` ç¼“å­˜è®¡ç®—ç»“æœ
- ä½¿ç”¨ `useCallback` ä¼˜åŒ–äº‹ä»¶å¤„ç†å‡½æ•°
- å¯¹è¾“å…¥å˜åŒ–è¿›è¡Œé˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è®¡ç®—
- è€ƒè™‘ä½¿ç”¨ Web Worker è¿›è¡Œå¤æ‚è®¡ç®—ï¼ˆå¦‚æœéœ€è¦ï¼‰